---
title: "Group exercise 3: The spread of COVID-19 in the US"
subtitle: "DATA5207: Data Analysis in the Social Sciences"
author: Emily and Sarah
output:
  pdf_document:
    toc: no
    latex_engine: xelatex
header-includes:
   - \usepackage{caption}
   - \captionsetup[figure]{font=scriptsize}
# mainfont: Avenir Book
urlcolor: blue

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, messages = FALSE)

library (tidyverse)
memory.limit(size = 32000)  # Increase to 16 GB, adjust as needed
library(tigris)
library(sf)

```

 
# Load Data and Preprocess


```{r load google mobility data}

google.mobility <- read.csv('Data/Global_Mobility_Report.csv') %>%
  filter(country_region == 'United States')

```

```{r}
confirmed.cases.data <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")

# load packages

library(tidyr)
library(DataCombine)


# clean data

confirmed.cases.data2 <- confirmed.cases.data %>%
  dplyr::rename(state = Province_State,
                county = Admin2) %>% 
  dplyr::select(-UID, -iso2, -iso3, -code3,
                -Lat, -Long_, -Combined_Key, -Country_Region) %>% 
    gather(date, confirmed.cases,-state,-county,-FIPS) %>%
  dplyr::mutate(date = gsub('X', '', date), 
                date = as.Date(as.character(date), "%m.%d.%y"),
                county_state = paste0(county, ', ', state)) %>%
  arrange(county_state, date) %>%
  dplyr::mutate(lag = slide(.,
                                  Var = 'confirmed.cases', 
                                  NewVar = 'new',
                                  GroupVar = 'county_state', 
                                  slideBy = -1)[,'new'],
                new.cases = confirmed.cases - lag)


## calculate rolling averages and remove non-states

covid.smooth.data_county <- confirmed.cases.data2 %>%
    dplyr::group_by(county_state, date) %>% 
    dplyr::summarise(new.cases = sum(new.cases)) %>%
      dplyr::group_by(county_state) %>% 
    dplyr::mutate(cases_14days = zoo::rollmean(new.cases, 
                                               k = 14, fill = 0)) %>% 
  dplyr::ungroup() %>% 
  mutate() %>% 
  merge(confirmed.cases.data2 %>% 
          dplyr::select(county_state, date, county, state)) %>% 
  filter(!state %in% c('American Samoa', 
                       'Diamond Princess',
                       'Grand Princess',
                       'Guam',
                       'Northern Mariana Islands',
                       'Puerto Rico',
                       'Virgin Islands'))
```


```{r load additional predictor data}

load("Data/county.data.RData")

```

```{r recoding data}

# patterns for cleaning county names

patterns <- c(' Borough| Census Area| County| Parish| city')


# covid case data 

covid.data <- covid.smooth.data_county %>% 
  
  # county data

left_join(county.data %>% 
            
            # grab file with full state names 
  
  left_join(read.csv('Data/fips concordance.csv') %>% 
              dplyr::select(State = Alpha.code, 
                            state_full = Name)) %>%
         dplyr::mutate(county = gsub(patterns, '', Area_Name),
                       county_state = paste0(county, ', ', state_full)) %>% 
    
    dplyr::select(county_state,
                  FIPS = FIPS,
                  total.population = POP_ESTIMATE_2018,
                  pop.density = Density.per.square.mile.of.land.area...Population,
                  age.65.plus = Total_age65plus,
                  avg.dec.temp = Dec.Temp.AVG...F,
                  avg.jan.temp = Jan.Temp.AVG...F,
                  avg.feb.temp = Feb.Temp.AVG...F,
                  avg.mar.temp = Mar.Temp.AVG...F,
                  avg.apr.temp = Apr.Temp.AVG...F,
                  avg.may.temp = May.Temp.AVG...F,
                  avg.jun.temp = Jun.Temp.AVG...F,
                  avg.jul.temp = Jul.Temp.AVG...F,
                  avg.aug.temp = Aug.Temp.AVG...F,
                  avg.sep.temp = Sep.Temp.AVG...F,
                  avg.oct.temp = Oct.Temp.AVG...F,
                  avg.nov.temp = Nov.Temp.AVG...F,
                  icu.beds = ICU.Beds,
                  active.physicians = Active.Physicians.per.100000.Population.2018..AAMC.,
                  active.patient.care.physicians = Total.Active.Patient.Care.Physicians.per.100000.Population.2018..AAMC.,
                  housing.density = Density.per.square.mile.of.land.area...Housing.units,
                  transit.scores = transit_scores...population.weighted.averages.aggregated.from.town.city.level.to.county)) %>%
    
    
  merge(google.mobility %>% 
          dplyr::mutate(county = gsub(patterns, '', sub_region_2),
                        county_state = paste0(county, ', ', sub_region_1),
                        date = as.Date(date),
                        mobility.transit = ifelse(is.na(transit_stations_percent_change_from_baseline), 0,
                                   transit_stations_percent_change_from_baseline)) %>% 
  
  dplyr::select(county_state,
                date,
                mobility.transit,
                mobility.workplaces = workplaces_percent_change_from_baseline,
                mobility.grocery = grocery_and_pharmacy_percent_change_from_baseline)) %>% 
  
  # convert to rates
  
  mutate(new.cases = new.cases / (total.population / 100000),
  #        icu.beds = icu.beds / (total.population / 100000),
         age.65.plus = age.65.plus / total.population)
  #        avg.winter.temp = (avg.dec.temp + avg.jan.temp + avg.feb.temp) / 3)


# lag new cases

new.cases.rate.lagged <- DataCombine::slide(covid.data,
                                     Var = 'new.cases', 
                                     NewVar = 'new.cases.lag',
                                     GroupVar = 'county_state', 
                                     slideBy = -1) 

# lag workplace mobility 

workplace.lag14 <- DataCombine::slide(covid.data,
                            Var = 'mobility.workplaces', 
                            NewVar = 'workplaces.lag14',
                            GroupVar = 'county_state', 
                            slideBy = -14)


# combine 

covid.data <- covid.data %>% 
  
  merge(new.cases.rate.lagged %>% 
            dplyr::select(county_state, date, 
                        new.cases.lag)) %>% 
  
    merge(workplace.lag14 %>% 
            dplyr::select(county_state, date, 
                        workplaces.lag14))


#covid.data <- covid.data %>%
 # merge(confirmed.cases.data %>%
  #        dplyr::rename(state = Province_State,
   #                     county = Admin2) %>%
    #      dplyr::select(-Lat, -Long_))

```

```{r}
# Summary statistics for age over 65
summary(covid.data$age.65.plus)

# Correlation between age over 65 and new cases
cor(covid.data$age.65.plus, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(covid.data$new.cases, covid.data$age.65.plus, ylab = "Age Over 65", xlab = "New COVID-19 Cases", main = "Age Over 65 vs. New COVID-19 Cases")


```

```{r}

specific_date <- as.Date("2020-07-20	")  
filtered_data <- covid.data %>%
  filter(date == specific_date)
# Summary statistics for population density
summary(covid.data$pop.density)

# Correlation between population density and new cases
cor(covid.data$pop.density, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(filtered_data$new.cases, filtered_data$pop.density, ylab = "Population Density", xlab = "New COVID-19 Cases", main = "Population Density vs. New COVID-19 Cases")
```

```{r}
# Summary statistics for active physicians per 100,000
summary(covid.data$active.patient.care.physicians)

# Correlation between active physicians and new cases
cor(covid.data$active.patient.care.physicians, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(covid.data$new.cases, covid.data$active.patient.care.physicians, ylab = "Active Physicians per 100,000", xlab = "New COVID-19 Cases", main = "Physicians vs. New COVID-19 Cases")
```

```{r}

us.shape.1 <- 
  st_read("US data for group task/US shapefiles/cb_2016_us_county_20m.shp")
```

```{r}
fip.concordance <- read.csv("Data/fips concordance.csv")
us.shape.2 <- us.shape.1 %>% 
  merge(fip.concordance %>%
          mutate(STATEFP =  ifelse(Numeric.code >= 0 & Numeric.code <= 9, 
                             paste0(0 , Numeric.code), Numeric.code)) %>%
          dplyr::rename(state = Alpha.code))
```

```{r}
# Check column names and data types


# Ensure FIPS column is correctly named and of the same type in both data frames
covid.data <- covid.data %>%
  mutate(FIPS = as.character(FIPS))

us.shape.2 <- us.shape.2 %>%
  mutate(GEOID = as.character(GEOID))
```


```{r}
# Function to perform join in chunks
join_in_chunks <- function(shape_data, covid_data, chunk_size = 1000) {
  n <- nrow(shape_data)
  result <- NULL
  
  for (i in seq(1, n, by = chunk_size)) {
    chunk <- shape_data[i:min(i + chunk_size - 1, n), ]
    chunk_result <- chunk %>%
      left_join(covid_data, by = c("GEOID" = "FIPS"))
    
    if (is.null(result)) {
      result <- chunk_result
    } else {
      result <- bind_rows(result, chunk_result)
    }
  }
  
  return(result)
}

# Perform join in chunks
county_data <- join_in_chunks(us.shape.2, covid.data, chunk_size = 1000)

county_data <- st_transform(county_data, crs = st_crs(5070))
```

```{r}
# Function to plot in chunks
county_data <- st_simplify(county_data, dTolerance = 1000)

# Function to plot in chunks
plot_in_chunks <- function(data, chunk_size = 1000) {
  n <- nrow(data)
  
  for (i in seq(1, n, by = chunk_size)) {
    chunk <- data[i:min(i + chunk_size - 1, n), ]
    
    # Plot Population Density
    ggplot(data = chunk) +
      geom_sf(aes(fill = pop_density), color = NA) +
      scale_fill_viridis_c(option = "viridis") +
      theme_minimal() +
      labs(title = paste("Population Density by County (Chunk", i, "to", min(i + chunk_size - 1, n), ")"),
           fill = "Density (per sq. mile)") +
      print()
  }
}

# Call the function to plot in chunks
plot_in_chunks(county_data, chunk_size = 1000)
```


```{r}
# Plot Age Over 65
ggplot(data = county_data) +
  geom_sf(aes(fill = age.65.plus), color = NA) +
  scale_fill_viridis_c(option = "viridis") +
  theme_minimal() +
  labs(title = "Proportion of Population Age 65+ by County",
       fill = "Proportion")

```

```{r}
# Plot Active Physicians per 100,000
ggplot(data = county_data) +
  geom_sf(aes(fill = active.patient.care.physicians), color = NA) +
  scale_fill_viridis_c(option = "viridis") +
  theme_minimal() +
  labs(title = "Active Physicians per 100,000 by County",
       fill = "Physicians/100k")
```

