---
title: "Group exercise 3: The spread of COVID-19 in the US"
author: "Emily and Sarah"
subtitle: 'DATA5207: Data Analysis in the Social Sciences'
output:
  html_document:
    code_folding: hide
    toc: no
    df_print: paged
  pdf_document:
    toc: no
    latex_engine: xelatex
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{font=scriptsize}
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, messages = FALSE)

library (tidyverse)
library(sf)
library(janitor)
library(sf)
library(scales) 
library(patchwork)
library(ggplot2)
library(rmapshaper)
library(tigris)
library(plotly)
devtools::install_github('bbc/bbplot')

```

# NOTE PLEASE SEE ARTICLE SECTION AT THE BOTTOM FOR JOURNAL ARTICLE
# Load Data and Preprocess

```{r load google mobility data, include=FALSE}
google.mobility <- read.csv('Data/Global_Mobility_Report.csv') %>%
  filter(country_region == 'United States')

```

```{r include=FALSE}
confirmed.cases.data <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")

```

```{r include=FALSE}
confirmed_deaths = read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv")
```

```{r load and clean confirmed case data by county, include=FALSE}


# load packages

library(tidyr)
library(DataCombine)

# clean data

confirmed.cases.data2 <- confirmed.cases.data %>%
  dplyr::rename(state = Province_State,
                county = Admin2) %>% 
  dplyr::select(-UID, -iso2, -iso3, -code3,
                -Lat, -Long_, -Combined_Key, -Country_Region) %>% 
    gather(date, confirmed.cases,-state,-county,-FIPS) %>%
  dplyr::mutate(date = gsub('X', '', date), 
                date = as.Date(as.character(date), "%m.%d.%y"),
                county_state = paste0(county, ', ', state)) %>%
  arrange(county_state, date) %>%
  dplyr::mutate(lag = slide(.,
                                  Var = 'confirmed.cases', 
                                  NewVar = 'new',
                                  GroupVar = 'county_state', 
                                  slideBy = -1)[,'new'],
                new.cases = confirmed.cases - lag)


## calculate rolling averages and remove non-states

covid.smooth.data_county <- confirmed.cases.data2 %>%
    dplyr::group_by(county_state, date) %>% 
    dplyr::summarise(new.cases = sum(new.cases)) %>%
      dplyr::group_by(county_state) %>% 
    dplyr::mutate(cases_14days = zoo::rollmean(new.cases, 
                                               k = 14, fill = 0)) %>% 
  dplyr::ungroup() %>% 
  mutate() %>% 
  merge(confirmed.cases.data2 %>% 
          dplyr::select(county_state, date, county, state)) %>% 
  filter(!state %in% c('American Samoa', 
                       'Diamond Princess',
                       'Grand Princess',
                       'Guam',
                       'Northern Mariana Islands',
                       'Puerto Rico',
                       'Virgin Islands'))
```

```{r include=FALSE}
confirmed_deaths_cleaned <- confirmed_deaths %>%
  dplyr::rename(state = Province_State,
                county = Admin2) %>% 
  dplyr::select(-UID, -iso2, -iso3, -code3,
                -Lat, -Long_, -Combined_Key, -Country_Region) %>% 
    gather(date, deaths,-state,-county,-FIPS) %>%
  dplyr::mutate(date = gsub('X', '', date), 
                date = as.Date(as.character(date), "%m.%d.%y"),
                county_state = paste0(county, ', ', state)) %>%
  arrange(county_state, date) %>%
  dplyr::mutate(lag = slide(.,
                                  Var = 'deaths', 
                                  NewVar = 'new',
                                  GroupVar = 'county_state', 
                                  slideBy = -1)[,'new'],
                new.deaths = deaths - lag)


## calculate rolling averages and remove non-states

confirmed_deaths_cleaned <- confirmed_deaths_cleaned %>%
    dplyr::group_by(county_state, date) %>% 
    dplyr::summarise(new.deaths = sum(new.deaths),FIPS) %>%
      dplyr::group_by(county_state) %>% 
    dplyr::mutate(deaths_14days = zoo::rollmean(new.deaths, 
                                               k = 14, fill = 0)) %>% 
  dplyr::ungroup() %>% 
  mutate() %>% 
  merge(confirmed_deaths_cleaned %>% 
          dplyr::select(county_state, date, county, state)) %>% 
  filter(!state %in% c('American Samoa', 
                       'Diamond Princess',
                       'Grand Princess',
                       'Guam',
                       'Northern Mariana Islands',
                       'Puerto Rico',
                       'Virgin Islands'))
```

```{r load additional predictor data, include=FALSE}


load("Data/county.data.RData")

```

#### Climate DF

```{r, include=FALSE}
# patterns for cleaning county names

patterns <- c(' Borough| Census Area| County| Parish| city')

climate.data <- county.data %>% 
    # grab file with full state names 
  
  left_join(read.csv('Data/fips concordance.csv') %>% 
              dplyr::select(State = Alpha.code, 
                            state_full = Name)) %>%
         dplyr::mutate(county = gsub(patterns, '', Area_Name),
                       county_state = paste0(county, ', ', state_full),
                       state = state_full) %>% 
    
    dplyr::select(county,
                  county_state,
                  state,
                  avg.dec.temp = Dec.Temp.AVG...F,
                  avg.jan.temp = Jan.Temp.AVG...F,
                  avg.feb.temp = Feb.Temp.AVG...F,
                  avg.mar.temp = Mar.Temp.AVG...F,
                  avg.apr.temp = Apr.Temp.AVG...F,
                  avg.may.temp = May.Temp.AVG...F,
                  avg.jun.temp = Jun.Temp.AVG...F,
                  avg.jul.temp = Jul.Temp.AVG...F,
                  avg.aug.temp = Aug.Temp.AVG...F,
                  avg.sep.temp = Sep.Temp.AVG...F,
                  avg.oct.temp = Oct.Temp.AVG...F,
                  avg.nov.temp = Nov.Temp.AVG...F)
    
```

#### Mobility DF

```{r, include=FALSE}
mobility.data <- google.mobility %>% 
          dplyr::mutate(county = gsub(patterns, '', sub_region_2),
                        state = sub_region_1,
                        date = as.Date(date)) %>%
  dplyr::select(county,
                state,
                date,
                mobility.transit = transit_stations_percent_change_from_baseline,
                mobility.workplaces = workplaces_percent_change_from_baseline,
                mobility.grocery = grocery_and_pharmacy_percent_change_from_baseline)
  
```

```{r include=FALSE}
mobility.data <- na.omit(mobility.data)
```

```{r checking blank rows,include=FALSE}
blank_counts <- sapply(mobility.data, function(col) sum(col == ""))
print(blank_counts)
```

```{r removing said blank rows,include=FALSE}
clean.mobility.data <- mobility.data %>% filter(county != "")
clean.mobility.data <- clean.mobility.data %>% filter(state != "")
```

#### Transit DF

```{r include=FALSE}
# patterns for cleaning county names

patterns <- c(' Borough| Census Area| County| Parish| city')

transit.data <- county.data %>% 
    # grab file with full state names 
  
  left_join(read.csv('Data/fips concordance.csv') %>% 
              dplyr::select(State = Alpha.code, 
                            state_full = Name)) %>%
         dplyr::mutate(county = gsub(patterns, '', Area_Name),
                       county_state = paste0(county, ', ', state_full),
                       state = state_full) %>% 
    
    dplyr::select(county,
                  county_state,
                  state,
                  transit.scores = transit_scores...population.weighted.averages.aggregated.from.town.city.level.to.county) 
    
```

#### Collated Data

```{r recoding data, include=FALSE}

# patterns for cleaning county names

patterns <- c(' Borough| Census Area| County| Parish| city')


# covid case data 
load("Data/covid.RData")

covid.data <- covid.smooth.data_county %>% 
  
  # county data

left_join(county.data %>% 
            
            # grab file with full state names 
  
  left_join(read.csv('Data/fips concordance.csv') %>% 
              dplyr::select(State = Alpha.code, 
                            state_full = Name)) %>%
         dplyr::mutate(county = gsub(patterns, '', Area_Name),
                       county_state = paste0(county, ', ', state_full)) %>% 
    
    dplyr::select(county_state,
                  FIPS = FIPS,
                  total.population = POP_ESTIMATE_2018,
                  pop.density = Density.per.square.mile.of.land.area...Population,
                  age.65.plus = Total_age65plus,
                  avg.dec.temp = Dec.Temp.AVG...F,
                  avg.jan.temp = Jan.Temp.AVG...F,
                  avg.feb.temp = Feb.Temp.AVG...F,
                  avg.mar.temp = Mar.Temp.AVG...F,
                  avg.apr.temp = Apr.Temp.AVG...F,
                  avg.may.temp = May.Temp.AVG...F,
                  avg.jun.temp = Jun.Temp.AVG...F,
                  avg.jul.temp = Jul.Temp.AVG...F,
                  avg.aug.temp = Aug.Temp.AVG...F,
                  avg.sep.temp = Sep.Temp.AVG...F,
                  avg.oct.temp = Oct.Temp.AVG...F,
                  avg.nov.temp = Nov.Temp.AVG...F,
                  icu.beds = ICU.Beds,
                  active.physicians = Active.Physicians.per.100000.Population.2018..AAMC.,
                  active.patient.care.physicians = Total.Active.Patient.Care.Physicians.per.100000.Population.2018..AAMC.,
                  housing.density = Density.per.square.mile.of.land.area...Housing.units,
                  transit.scores = transit_scores...population.weighted.averages.aggregated.from.town.city.level.to.county)) %>%
    
    
  merge(google.mobility %>% 
          dplyr::mutate(county = gsub(patterns, '', sub_region_2),
                        county_state = paste0(county, ', ', sub_region_1),
                        date = as.Date(date),
                        mobility.transit = ifelse(is.na(transit_stations_percent_change_from_baseline), 0,
                                   transit_stations_percent_change_from_baseline)) %>% 
  
  dplyr::select(county_state,
                date,
                mobility.transit,
                mobility.workplaces = workplaces_percent_change_from_baseline,
                mobility.grocery = grocery_and_pharmacy_percent_change_from_baseline)) %>% 
  
  # convert to rates
  
  mutate(new.cases = new.cases / (total.population / 100000),
  #        icu.beds = icu.beds / (total.population / 100000),
         age.65.plus = age.65.plus / total.population)
  #        avg.winter.temp = (avg.dec.temp + avg.jan.temp + avg.feb.temp) / 3)


# lag new cases

new.cases.rate.lagged <- DataCombine::slide(covid.data,
                                     Var = 'new.cases', 
                                     NewVar = 'new.cases.lag',
                                     GroupVar = 'county_state', 
                                     slideBy = -1) 

# lag workplace mobility 

workplace.lag14 <- DataCombine::slide(covid.data,
                            Var = 'mobility.workplaces', 
                            NewVar = 'workplaces.lag14',
                            GroupVar = 'county_state', 
                            slideBy = -14)


# combine 

covid.data <- covid.data %>% 
  
  merge(new.cases.rate.lagged %>% 
            dplyr::select(county_state, date, 
                        new.cases.lag)) %>% 
  
    merge(workplace.lag14 %>% 
            dplyr::select(county_state, date, 
                        workplaces.lag14))


#covid.data <- covid.data %>%
 # merge(confirmed.cases.data %>%
  #        dplyr::rename(state = Province_State,
   #                     county = Admin2) %>%
    #      dplyr::select(-Lat, -Long_))

```

```{r, include=FALSE}
colnames(covid.data)
```

```{r link us data with shape files, warning=FALSE, message=FALSE, include=FALSE}
#Add shape files for any mapping tasks later

us.shape.1 <- 
  st_read("Data/US shapefiles/cb_2016_us_county_20m.shp")
us.shape.1 <- us.shape.1 %>%
  shift_geometry() #This function moves alaska into a easier area to interpret

```

```{r include=FALSE}

fip.concordance <- read.csv("Data/fips concordance.csv")

us.shape.2 <- us.shape.1 %>% 
  merge(fip.concordance %>%
          mutate(STATEFP =  ifelse(Numeric.code >= 0 & Numeric.code <= 9, 
                             paste0(0 , Numeric.code), Numeric.code)) %>%
          dplyr::rename(state = Alpha.code))


us.shape.2$county <- paste0(us.shape.2$NAME, ", ", us.shape.2$state)

us.shape.2$county <- gsub("Doña Ana, NM", "Dona Ana, NM", us.shape.2$county)
us.shape.2$county <- gsub("LaSalle, LA", "La Salle, LA", us.shape.2$county)
us.shape.2$county <- gsub("Oglala Lakota, SD", "Oglala, SD", us.shape.2$county)

```

```{r link shapefiles with fip concordance file, include=FALSE}

# Summary statistics for age over 65
summary(covid.data$age.65.plus)

# Correlation between age over 65 and new cases
cor(covid.data$age.65.plus, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(covid.data$new.cases, covid.data$age.65.plus, ylab = "Age Over 65", xlab = "New COVID-19 Cases", main = "Age Over 65 vs. New COVID-19 Cases")


```

```{r include=FALSE}

specific_date <- as.Date("2020-07-20	")  
filtered_data <- covid.data %>%
  filter(date == specific_date)
# Summary statistics for population density
summary(covid.data$pop.density)

# Correlation between population density and new cases
cor(covid.data$pop.density, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(filtered_data$new.cases, filtered_data$pop.density, ylab = "Population Density", xlab = "New COVID-19 Cases", main = "Population Density vs. New COVID-19 Cases")
```

```{r include=FALSE}
# Summary statistics for active physicians per 100,000
summary(covid.data$active.patient.care.physicians)

# Correlation between active physicians and new cases
cor(covid.data$active.patient.care.physicians, covid.data$new.cases, use = "complete.obs")

# Scatter plot
plot(covid.data$new.cases, covid.data$active.patient.care.physicians, ylab = "Active Physicians per 100,000", xlab = "New COVID-19 Cases", main = "Physicians vs. New COVID-19 Cases")
```

# Descriptive Analysis

## Transit

```{r}
max_row_index <- which.max(transit.data$transit.score)
max_row <- transit.data[max_row_index, ]
print(max_row)
```
```{r}
max_row_index <- which.min(transit.data$transit.score)
max_row <- transit.data[max_row_index, ]
print(max_row)
```


```{r include=FALSE}

na_count_per_column <- transit.data %>%
  summarise_all(~ sum(is.na(.)))
print(na_count_per_column)

```

```{r remove NA values, include=FALSE}
clean.transit.data <- na.omit(transit.data)

# standardise
clean.transit.data <- clean.transit.data %>%
  mutate(z.transit = (transit.scores - mean(transit.scores, na.rm=T)) / 
           sd(transit.scores, na.rm=T))
```


```{r link the geometry with transit data, include=FALSE}
us.shape.2 <- us.shape.2 %>%
  select(-county, -Name, -Status, -COUNTYFP, -COUNTYNS, -STATEFP, -AFFGEOID, -LSAD, -ALAND, -AWATER, -Numeric.code, -Status)%>%
  rename(county = NAME)

transit.map <- full_join(us.shape.2,
                         clean.transit.data %>% 
                           select(county, state, z.transit), 
                         by = "county") %>%
              st_as_sf()
```



## Mobility

```{r include=FALSE}
# install.packages("zoo")
library(zoo)
```

```{r summarise data, include=FALSE}
summarise.mobility.data <- clean.mobility.data %>%
  group_by(date) %>%
  summarise(mobility.transit = mean(mobility.transit, na.rm = TRUE),
            mobility.grocery = mean(mobility.grocery, na.rm = TRUE),
            mobility.workplaces = mean(mobility.workplaces, na.rm = TRUE))


# Mobility Values: Each value in the dataset represents a percentage change from a baseline.
# Rolling Average: The 7-day rolling average smooths these daily percentage changes to show a trend over time.
# Percentage Representation: The rolling average remains a percentage because it’s derived from percentage values.

# Calculate rolling 7 day average
grocery.mobility.data <- summarise.mobility.data %>%
  arrange(date) %>%
  mutate(rolling_avg = zoo::rollmean(mobility.grocery, 7, fill = NA, align = "right"))

transit.mobility.data <- summarise.mobility.data %>%
  arrange(date) %>%
  mutate(rolling_avg = zoo::rollmean(mobility.transit, 7, fill = NA, align = "right"))


workplace.mobility.data <- summarise.mobility.data %>%
  arrange(date) %>%
  mutate(rolling_avg = zoo::rollmean(mobility.workplaces, 7, fill = NA, align = "right"))


```

```{r include=FALSE}
ggplot(grocery.mobility.data, aes(x = date, y = rolling_avg)) +
  geom_line(color = "blue") +
  labs(title = "Changes in Visitors to Grocery and Pharmacy Stores Over Time",
       x = "Date",
       y = "7-day Rolling Average of Mobility (%)") +
  bbplot::bbc_style()+
  theme(plot.title = element_text(size = 12),
        axis.title.x = element_text(size = 8), # Adjust the x-axis label size
    axis.title.y = element_text(size = 8))
```

```{r include=FALSE}
ggplot(grocery.mobility.data, aes(x = date, y = rolling_avg)) +
  geom_line(color = "blue", size = 1) +  # Thicker line for better visibility
  # geom_point(color = "red", size = 1, alpha = 0.7) +  # Adding points for data
  labs(title = "Changes in Visitors to Grocery and Pharmacy Stores Over Time",
       x = "Date",
       y = "7-day Rolling Average of Mobility (%)") +
  bbplot::bbc_style() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),  # Larger, bold title
    axis.title.x = element_text(size = 12),  # Larger x-axis label
    axis.title.y = element_text(size = 12),  # Larger y-axis label
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),  # Rotate x-axis labels for better readability
    axis.text.y = element_text(size = 10)
  ) +
  scale_x_date(date_labels = "%b %Y", date_breaks = "1 month") +  # Format x-axis dates
  geom_vline(xintercept = as.numeric(as.Date(c("2020-03-11", "2020-12-25"))),  # Add vertical lines for significant dates
             linetype = "dashed", color = "grey50") +
  annotate("text", x = as.Date("2020-03-11"), y = max(grocery.mobility.data$rolling_avg, na.rm = TRUE)* -0.5,
           label = "Pandemic Declared", angle = 90, vjust = -0.5, size = 3, color = "grey50") +
  annotate("text", x = as.Date("2020-12-25"), y = max(grocery.mobility.data$rolling_avg, na.rm = TRUE)* 0.8,
           label = "Christmas", angle = 90, vjust = -0.5, size = 3, color = "grey50")
```

```{r }
ggplot(transit.mobility.data, aes(x = date, y = rolling_avg)) +
  geom_line(color = "blue") +
  labs(title = "Changes in Visitors to Transit Over Time",
       x = "Date",
       y = "7-day Rolling Average of Mobility (%)") +
  theme_minimal()
```

```{r}
ggplot(workplace.mobility.data, aes(x = date, y = rolling_avg)) +
  geom_line(color = "blue") +
  labs(title = "Changes in Visitors to Workplaces Over Time",
       x = "Date",
       y = "7-day Rolling Average of Mobility (%)") +
  theme_minimal()
```


## Climate data

```{r include=FALSE}
# Changing the climate data from a wide format to long format:
climate.data <- climate.data %>%
  dplyr::select(county, 
                state,
                avg.temp.jan = avg.jan.temp,
                avg.temp.feb = avg.feb.temp,
                avg.temp.mar = avg.mar.temp,
                avg.temp.apr = avg.apr.temp,
                avg.temp.may = avg.may.temp,
                avg.temp.jun = avg.jun.temp,
                avg.temp.jul = avg.jul.temp,
                avg.temp.aug = avg.aug.temp,
                avg.temp.sep = avg.sep.temp,
                avg.temp.oct = avg.oct.temp,
                avg.temp.nov = avg.nov.temp,
                avg.temp.dec = avg.dec.temp)


climate.data.long <- climate.data %>%
  pivot_longer(
    cols = starts_with("avg.temp."),
    names_to = "month",
    values_to = "temp"
  )

climate.data.long <- climate.data.long %>%
  mutate(month = case_when(
    month == "avg.temp.jan" ~ "Jan",
    month == "avg.temp.feb" ~ "Feb",
    month == "avg.temp.mar" ~ "Mar",
    month == "avg.temp.apr" ~ "Apr",
    month == "avg.temp.may" ~ "May",
    month == "avg.temp.jun" ~ "Jun",
    month == "avg.temp.jul" ~ "Jul",
    month == "avg.temp.aug" ~ "Aug",
    month == "avg.temp.sep" ~ "Sep",
    month == "avg.temp.oct" ~ "Oct",
    month == "avg.temp.nov" ~ "Nov",
    month == "avg.temp.dec" ~ "Dec",
    TRUE ~ month
  ))
```

```{r link us data with shape files2, message=FALSE, include=FALSE}
# us.shape.2 <- us.shape.2 %>%
#   select(-county, -Name, -Status, -COUNTYFP, -COUNTYNS, -STATEFP, -AFFGEOID, -GEOID, -LSAD, -ALAND, -AWATER, -Numeric.code, -Status)%>%
#   rename(county = NAME)

# Don't want to include missing data since its not useful - hence inner join 
climate.map <- full_join(us.shape.2,
                         climate.data.long %>% 
                           select(county, state, month, temp), 
                         by = "county") %>%
              st_as_sf()
 # To acknolwedge its a shape file
```

```{r collate climate data and plot over time, include=FALSE}

climate.state <- climate.data.long %>%
  group_by(state, month)%>%
  summarise(avg_temp = mean(temp, na.rm= TRUE, .groups = 'drop'))


ggplot(climate.state, aes(x = month, y = avg_temp, group = state, color = state)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Temperature Over Each Month Per State",
       x = "Month",
       y = "Average Temperature") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 12),  # Set title size
    axis.title.x = element_text(size = 10), # Set x-axis label size
    axis.title.y = element_text(size = 10), # Set y-axis label size
    legend.position = "bottom",  # Move legend below plot
    legend.title = element_blank(),  # Remove legend title
    legend.text = element_text(size = 8)  # Set legend text size
  ) +
  guides(color = guide_legend(nrow = 5))  # Set legend to one row
```

```{r}


# Create the plot using ggplot
p <- ggplot(climate.state, aes(x = month, y = avg_temp, group = state, color = state)) +
  geom_line() +
  geom_point() +
  labs(title = "Average Temperature Over Each Month Per State",
       x = "Month",
       y = "Average Temperature") +
  theme_minimal()

# Convert the ggplot object to plotly
p <- ggplotly(p, tooltip = c("x", "y", "color"))

# Show the interactive plot
p
```

```{r include=FALSE}

# Ensure FIPS column is correctly named and of the same type in both data frames
county.data <- county.data %>%
  mutate(FIPS = as.character(FIPS))

us.shape.2 <- us.shape.2 %>%
  mutate(GEOID = as.character(GEOID))

covid.data <- covid.data %>%
  mutate(FIPS = as.character(FIPS))

confirmed_deaths_cleaned <- confirmed_deaths_cleaned %>%
  mutate(FIPS = as.character(FIPS))
```

```{r include=FALSE}


county.data$FIPS <- str_pad(as.character(county.data$FIPS), width = 5, pad = "0")

# Function to perform join in chunks
join_in_chunks <- function(shape_data, covid_data, chunk_size = 1000) {
  n <- nrow(shape_data)
  result <- NULL
  
  for (i in seq(1, n, by = chunk_size)) {
    chunk <- shape_data[i:min(i + chunk_size - 1, n), ]
    chunk_result <- chunk %>%
      left_join(covid_data, by = c("GEOID" = "FIPS"))
    
    if (is.null(result)) {
      result <- chunk_result
    } else {
      result <- bind_rows(result, chunk_result)
    }
  }
  
  return(result)
}

# Perform join in chunks


county_data_geo <- join_in_chunks(us.shape.2, county.data, chunk_size = 1000)


```

```{r include=FALSE}
county.covid = join_in_chunks(us.shape.2, covid.data, chunk_size = 1000)
```

```{r include=FALSE}
# Summarize the data (assuming you have a county.covid dataset)
county_cases_sum <- county.covid %>%
  group_by(GEOID) %>%
  summarize(new_cases_sum = sum(new.cases, na.rm = TRUE),
            new_case_max = max(new.cases, na.rm = TRUE), ,
            county = first(county.x), )


```

```{r include=FALSE}
county_cases_sum <- county_cases_sum %>%
  mutate(centroid = st_centroid(geometry))

# Extract coordinates from the centroids
county_cases_sum <- county_cases_sum %>%
  mutate(long = st_coordinates(centroid)[,1],
         lat = st_coordinates(centroid)[,2])
```

```{r include=FALSE}
# Highlight top counties with the highest new cases
top_counties <- county_cases_sum %>%
  arrange(desc(new_cases_sum)) %>%
  head(20)

top_counties_50 <- county_cases_sum %>%
  arrange(desc(new_cases_sum)) %>%
  head(100)
```

```{r include=FALSE}
top_densities <- county.data %>%
  arrange(desc(Density.per.square.mile.of.land.area...Population)) %>%
  select(FIPS, Density = Density.per.square.mile.of.land.area...Population, Area_Name)  %>%
  head(20)



lowest_physic <- county.data %>%
  arrange(Total.Active.Patient.Care.Physicians.per.100000.Population.2018..AAMC.) %>%
  select(FIPS, 'ActivePhy/100k' = Total.Active.Patient.Care.Physicians.per.100000.Population.2018..AAMC., Area_Name)  %>%
  head(20)

top_65 <- county.data %>%
  mutate(`65plus%` = (Total_age65plus / POP_ESTIMATE_2018) * 100) %>%
  arrange(desc(`65plus%`)) %>%
  select(FIPS, `65plus%`, Area_Name) %>%
  head(20)


```

```{r include=FALSE}
confirmed_deaths_cleaned_sum <- confirmed_deaths_cleaned %>%
  arrange(desc(new.deaths)) 
  
```

```{r include=FALSE}
top_deaths <- confirmed_deaths_cleaned_sum %>%
  arrange(desc(new.deaths)) %>%
  head(20)
```

```{r include=FALSE}
Density_Cross = inner_join(top_densities, top_counties, by = c('FIPS' = 'GEOID'))
Density_Cross_deaths = inner_join(top_densities, top_deaths, by = c('FIPS' = 'FIPS'))
Density_Cross$Area_Name
Density_Cross_deaths$Area
```




## Statistical Analysis

This statement that population density is more significant to contributing to case numbers can be proved statistically.

```{r see the significance of proportiona of 65+, include=FALSE}

county_cases_sum_df <- as.data.frame(county_cases_sum)

county.covid_df <- as.data.frame(county.covid)
county.covid_df <- na.omit(county.covid_df)
county.covid_df <- county.covid_df %>%
  select(GEOID, pop.density, age.65.plus, active.patient.care.physicians)
model_df = left_join(county_cases_sum_df, county.covid_df, by = 'GEOID')

model_df <- na.omit(model_df)

model_df <- model_df %>%
  distinct(GEOID, .keep_all = TRUE)

model_proption65 = lm(new_cases_sum ~ pop.density + age.65.plus + active.patient.care.physicians, model_df)
# Tidy the model output
summary(model_proption65)
```

As seen above, compared to the other two variables, population density is most siginificant to indicating new cases.



# Model

"county_state" "date" "new.cases"\
[4] "cases_14days" "county" "state"\
[7] "FIPS" "total.population" "pop.density"\
[10] "age.65.plus" "avg.dec.temp" "avg.jan.temp"\
[13] "avg.feb.temp" "avg.mar.temp" "avg.apr.temp"\
[16] "avg.may.temp" "avg.jun.temp" "avg.jul.temp"\
[19] "avg.aug.temp" "avg.sep.temp" "avg.oct.temp"\
[22] "avg.nov.temp" "icu.beds" "active.physicians"\
[25] "active.patient.care.physicians" "housing.density" "transit.scores"\
[28] "mobility.transit" "mobility.workplaces" "mobility.grocery"\
[31] "new.cases.lag" "workplaces.lag14"

```{r see the significance of temperature}
model2 <- lm(cases_14days ~ avg.jan.temp + avg.feb.temp + avg.mar.temp + avg.apr.temp + avg.may.temp + avg.jun.temp + avg.jul.temp + avg.aug.temp + avg.sep.temp + avg.oct.temp + avg.nov.temp + avg.dec.temp , covid.data)

summary(model2)
```

```{r see the significance of mobility}
model3 <- lm(cases_14days ~mobility.transit +mobility.grocery +mobility.workplaces + avg.jan.temp + avg.feb.temp + avg.mar.temp + avg.apr.temp + avg.may.temp + avg.jun.temp + avg.jul.temp + avg.aug.temp + avg.sep.temp + avg.oct.temp + avg.nov.temp + avg.dec.temp, covid.data)
summary(model3)
```

\newpage

# Article

# Dissecting the COVID-19 Divide: Why Some US Counties were hit harder than others

## Introduction
After January 20,2020, when Centers for Disease Control and Prevention (CDC) reported the first laboratory-confirmed case of the 2019 Coronavirus, this was promptly announced as a public health emergency on January 31st and became the third -leading cause of death in the US in 2020. Despite the worldwide spread of the pandemic, the effects were profoundly uneven in the United States with some areas experience higher rates than others. This disparity can be attributed to a combinations of statistically significant factors including population density, mobility patterns, age demographics, public transportation scores, climate conditions and healthcare resources.

Below is an interactive graph that demonstrates displays the top 100 counties and their new covid cases over 2020 - 2021. It can be identified visually the different Covid-waves/influxes in cases.

```{r include=FALSE}

county.covid$date <- as.Date(county.covid$date)

# Filter the data for the year 2021
county.covid_2021 <- county.covid %>%
  filter(year(date) == c(2020, 2021))
```

```{r include=FALSE}
# Ensure the geometry column is in the correct format and extract centroids
county.covid_2021 <- st_transform(county.covid_2021, 4326)
county.covid_2021$centroid <- st_centroid(st_geometry(county.covid_2021))

# Extract coordinates from centroids
county.covid_df <- county.covid_2021 %>%
  mutate(long = st_coordinates(centroid)[,1],
         lat = st_coordinates(centroid)[,2]) %>%
  as.data.frame() %>%
  select(-geometry, -centroid)  # Remove geometry columns as they are now in long and lat

```

```{r include=FALSE}
start_date <- as.Date("2020-01-01")
county.covid_df <- county.covid_df %>%
  mutate(year_month = floor_date(date, "month"))

# Summarize the data by month
county.covid_monthly <- county.covid_df %>%
  group_by(year_month, GEOID, county.x, long, lat) %>%
  summarize(new.cases = sum(new.cases, na.rm = TRUE), .groups = 'drop')
```

```{r include=FALSE}
top_counties_50 <- top_counties_50$county
county.covid_monthly <- county.covid_monthly %>%
  filter(county.x %in% top_counties_50)

county.covid_long_top_df <- as.data.frame(county.covid_monthly)

# Drop the geometry column

# Then proceed with the
head(county.covid_long_top_df)
```

```{r include=FALSE}
max_cases <- max(county.covid_long_top_df$new.cases, na.rm = TRUE)
min_cases <- min(county.covid_long_top_df$new.cases, na.rm = TRUE)

county.covid_long_top_df <- county.covid_long_top_df %>%
  mutate(marker_size = (new.cases - min_cases) / (max_cases - min_cases) * 50) # Scale to a range (e.g., 0 to 50)

# Ensure the scaling factor enhances visibility
scaling_factor <- 2
```

```{r}
fig <- plot_ly(county.covid_long_top_df,
               x = ~long,
               y = ~lat,
               frame = ~year_month,
               ids = ~GEOID,
               type = 'scattergeo',
               mode = 'markers',
               text = ~county.x,        # Set the hover text to the county name
               hoverinfo = 'text',    # Only display the text (county name) in the hover info
               marker = list(
                 size = ~log(new.cases), # Set the size of the markers based on the normalized new cases
                 color = 'red',        # Optional: Set a constant color for the markers
                 opacity = 0.6,
                 line = list(width = 0)
               ),
               name = 'COVID-19 Cases') %>%
  layout(
    title = "New COVID-19 Cases by County in 2021 for Highest Reporting Counties",
    geo = list(
      scope = 'usa',               # Set the map scope to the USA
      projection = list(type = 'albers usa'),
      showland = TRUE,
      landcolor = 'rgb(217, 217, 217)',
      subunitwidth = 1,
      countrywidth = 1,
      subunitcolor = 'rgb(255, 255, 255)',
      countrycolor = 'rgb(255, 255, 255)'
    ),
    margin = list(l = 0, r = 0, t = 30, b = 0) # Adjust the margins if needed
  ) %>%
  animation_opts(frame = 1000, easing = "elastic", redraw = TRUE) %>%
  animation_button(x = 1, xanchor = "right", y = 0, yanchor = "bottom")

# Render the plotly object
fig
```
 
## Population Density: Urban-Rural Separation

The density per county, which measures the number of people living in a given area within a county, is an important factor in the spread of infectious diseases like COVID-19. Higher density means more people are concentrated in a smaller area, increasing the likelihood of person-to-person transmission through close contact. By analysing density per county, we can assess how different population concentrations impact the rate of new infections. This information can help identify areas that might need more stringent public health measures to control the spread of the virus.

As seen below area, with the highest areas tend to have higher number of case of covid.

```{r}
ggplot(data = county_data_geo) +
      geom_sf(aes(fill = log(Density.per.square.mile.of.land.area...Population)), color = NA) +
      scale_fill_viridis_c(option = "viridis") +
      theme_minimal() +
      labs(title = "Population Density by County Standardised", 
           fill = "Density (per sq. mile)") +
  geom_point(data = top_counties, aes(x = long, y = lat, size = new_cases_sum), color = "red", alpha = 0.7) +
  scale_size_continuous(name = "Summed New Cases") +
  theme(legend.position = "right", axis.title.x = element_blank(),  # Remove x-axis title
        axis.title.y = element_blank())
```

Additionally, the county areas below show that within the 20 most dense counties, there is an intersection counties with the highest case number

```{r}
Density_Cross$Area_Name
```

Additionally, this extend beyond case numbers and is also true for deaths in counties.

```{r}
Density_Cross_deaths$Area
```


##Mobility Patterns: Grocery Store Effect
Lockdowns and stay-at-home orders were implemented in numerous states as a means of slowing the spread of the virus by enforcing physical distance between people. However, these stringent regulations were variable between states and a Columbia University model estimated 54,000  deaths would have been prevented if the enacted restrictions started earlier in a few states. 
How effective have these policies been in reducing human movement? What impact did they have on how people work, live and visit? Insights can be drawn from Google’s COVID-19 Community Mobility Reports. Using anonymized data from apps like Google Maps, these reports provide a regularly updated dataset showing how people's movements have changed throughout the pandemic.

We have plotted three of these trends in the interactive graph below. 
- Grocery and pharmacy: Mobility trends for places like grocery markets, food warehouses, farmers markets, specialty food shops, drug stores, and pharmacies.
- Transit stations: Mobility trends for places like public transport hubs such as subway, bus, and train stations.
- Workplaces: Mobility trends for places of work.

```{r}

# Add a type column to each dataframe
grocery.mobility.data <- grocery.mobility.data %>%
  mutate(type = "Grocery and Pharmacy")

transit.mobility.data <- transit.mobility.data %>%
  mutate(type = "Transit")

workplace.mobility.data <- workplace.mobility.data %>%
  mutate(type = "Workplace")

# Combine the dataframes into one
combined_mobility_data <- bind_rows(grocery.mobility.data, transit.mobility.data, workplace.mobility.data)

# Create the ggplot
p <- ggplot(combined_mobility_data, aes(x = date, y = rolling_avg, color = type)) +
  geom_line() +
  labs(title = "Changes in Mobility Over Time",
       x = "Date",
       y = "7-day Rolling Average of Mobility (%)",
       color = "Mobility Type") +
  theme_minimal()

# Convert the ggplot to an interactive plotly plot
interactive_plot <- ggplotly(p)

# Display the interactive plot
interactive_plot

```

The sharp decline initially shows the inital lockdown that the US went through. After that workplace mobility demonstrated the slowest increase while grocery and pharmacy demonstrating higher than baseline consistently, even after lockdown. This demonstrates the necessity for people to still be visiting these sorts of areas while as workplaces locked down with working from home as an option. The distinct drop in December 29 highlights the first US case of new COVID-19 variant found in Colorado.

Counties and mobility demonstrated statistically significant relationships. This is particularly evident in suburban areas where residents travel more frequently for essentials. The mobility dataset provided by Google demonstrates how visits and length of stay at different places change compared to a baseline. Changes for each day are compared to a baseline value for that day of the week, with the baseline being a median value for the corresponding day of the week during the 5-week period from Jan 3 to Feb 6, 2020. Google recommends not comparing day-to-day changes directly. Instead, they suggest smoothing the index to a rolling 7-day average for more accurate analysis. 

##Age Demographics: Vulnerability of Elderly The age distribution of a population, particularly the proportion of individuals over 65, is essential in studying COVID-19 spread and impact. Older adults are more susceptible to severe illness and complications from COVID-19. They are also more likely to require hospitalisation and intensive care. By examining the share of the population over 65, we can assess the potential burden on healthcare systems and identify regions where protective measures and vaccination campaigns might need to be prioritised to protect this vulnerable group.

Seen below, a visual trend of areas with a higher proportion of 65+ indicates somewhat higher scores of covid cases. For example areas like Florida that historically have high numbers of retirees. However, the is no intersection between the county areas with the highest proportion of 65+ and covid cases.

```{r}
ggplot(data = county_data_geo) +
  geom_sf(aes(fill = log(Total_age85plusr/POP_ESTIMATE_2018)), color = NA) +
  scale_fill_viridis_c(option = "viridis") +
  theme_minimal() +
  labs(title = "Proportion of Population Age 65+ by County Standardised",
       fill = "Proportion") +
  geom_point(data = top_counties, aes(x = long, y = lat, size = new_cases_sum), color = "red", alpha = 0.7) +
  scale_size_continuous(name = "Summed New Cases") +
  theme(legend.position = "right", axis.title.x = element_blank(),  # Remove x-axis title
        axis.title.y = element_blank())
```


##Transit Scores: Public transport usage
Public transportation systems can act as a vector for virus spread, especially in counties with high transit scores. Buses, subways and trains, where social distancing is challenging, can quickly become hotspots. Data shows relationships with extensive public transport networks and higher COVID 19 cases, particularly in the initial phases of the pandemic. Transit scores are how well alocation is served by public transit and follows the below scoring:
| Transit Score® | Description                                 |
|----------------|---------------------------------------------|
| 90--100        | Rider's Paradise                            |
|                | World-class public transportation.          |
| 70--89         | Excellent Transit                           |
|                | Transit is convenient for most trips.       |
| 50--69         | Good Transit                                |
|                | Many nearby public transportation options.  |
| 25--49         | Some Transit                                |
|                | A few nearby public transportation options. |
| 0--24          | Minimal Transit                             |
|                | It is possible to get on a bus.             |

Below is a spread of the transit score distribution in America.

```{r}

ggplot(transit.map) +
  geom_sf(mapping = aes(fill = z.transit), colour = NA, inherit.aes = FALSE) +
  scale_fill_gradient2(
    low = "#2c7bb6",           # Blue
    mid = "#ffffbf",           # Yellow (midpoint)
    high = "#d7191c",          # Red
    midpoint = mean(transit.map$z.transit, na.rm = TRUE),
    limits = c(min(transit.map$z.transit, na.rm = TRUE),
               max(transit.map$z.transit, na.rm = TRUE)),
    label = scales::comma,
    na.value = "grey"
  ) +
  labs(title = 'Standardised Transit Distribution') +
  guides(fill = guide_legend(keyheight = 0.3)) +
  theme_void() +
  bbplot::bbc_style() +
  theme(
    plot.title = element_text(size = 16),         # Make the title larger
    legend.position = 'bottom',
    legend.title = element_blank(),
    legend.text = element_text(size = 10),        # Make legend text smaller
    axis.title = element_text(size = 10),         # Make axis labels smaller
    axis.text = element_text(size = 8)            # Make axis text smaller
  )

```


While many counties had a transit scores of 0, the top 5 counties included:
```{r}
sorted_df <- transit.data[order(-transit.data$transit.scores), ]

# Select the top 5 rows
top_5 <- sorted_df[1:5, ]

# Print the result
print(top_5)
```

```{r}
ggplot(clean.transit.data, aes(x = z.transit)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Standardised transit scores in America",
       x = "Transit Scores",
       y = "Frequency") +
  bbplot::bbc_style()+
  theme(plot.title = element_text(size = 12),
        axis.title.x = element_text(size = 8), # Adjust the x-axis label size
    axis.title.y = element_text(size = 8))
```


[insert table with counties w top 5 highest transit scores and their covid cases vs lowest 5]


##Climate: The highs and lows of average temperatures
Research  shows that COVID-19 tends to increase as temperature and humidity fall and despite year around activity, COVID-19 had seasonal spikes. 

Below shows the distribution of the average temperature over the months.

```{r map the average temperature for each month in each county}
month_order <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

# Convert the month variable to a factor with the desired order
climate.map$month <- factor(climate.map$month, levels = month_order)

ggplot(climate.map) +
  geom_sf(mapping = aes(fill = temp), colour = NA, inherit.aes = FALSE) +
  scale_fill_gradient2(low = "#0072B2",
                       high = "red",
                       midpoint = mean(climate.map$temp, na.rm = TRUE),
                       limits = c(min(climate.map$temp, na.rm = TRUE),
                                  max(climate.map$temp, na.rm = TRUE)),
                       label = scales::comma,
                       na.value = "grey") +
  labs(title = 'Average Climate distribution') +
  guides(fill = guide_legend(keyheight = 0.3)) +
  theme_void() +
  theme(plot.title = element_text(size = 7),
        legend.position = 'bottom',
        legend.title = element_blank()) +
  facet_wrap(~month) # This line tells ggplot to create separate panels for each unique value in the month column. Each panel will display the map for one month.

```

With more extreme weather conditions predominantly in (NORTH?SOUTH?) areas, the climate could be a significant factor in the distribution of COVID-19 cases. It is statistically significant to have a positive relationship between COVID cases and temperature increasing during transitionary months such as march and novemeber, suggesting that a change in season reduces immune systems. July interestingly saw the greatest positive relationship which negates the idea that cold weather brings along viruses and instead summer could relate to more time outside, causing greater transmission with others. 


## Healthcare Resources: Active Physicians per capita

The availability of healthcare resources, such as active physicians per 100,000 population, is a critical factor in managing and mitigating the effects of the COVID-19 pandemic. Areas with a higher number of active physicians can provide better medical care, testing, and treatment, which can help control the spread of the virus and reduce mortality rates. By analysing the distribution of active physicians, we can understand the capacity of different regions to respond to the pandemic and highlight areas that may need additional support and resources to effectively manage the healthcare demands caused by COVID-19.

However, the is no intersection between the county areas with the highest proportion of physicians and covid cases.

```{r}
# Plot Active Physicians per 100,000
ggplot(data = county_data_geo) +
  geom_sf(aes(fill = log(Total.Active.Patient.Care.Physicians.per.100000.Population.2018..AAMC.)), color = NA) +
  scale_fill_viridis_c(option = "viridis") +
  theme_minimal() +
  labs(title = "Active Physicians per 100,000 by County Standardised",
       fill = "Physicians/100k") +
  geom_point(data = top_counties, aes(x = long, y = lat, size = new_cases_sum), color = "red", alpha = 0.7) +
  scale_size_continuous(name = "Summed New Cases") +
  theme(legend.position = "right", axis.title.x = element_blank(),  # Remove x-axis title
        axis.title.y = element_blank())
```

Active physicians, may be a confounding factor with population density, as higher dense city-areas may attract more physicians. And as there is low evidence above that increased physicians means less cases, it demonstrates that density is a more telling factor of cases then physicians.

##Conclusions:
The spread of COVID-19 in the United States is a multifaceted issue influenced by an interplay of demographic, behavioral, and environmental factors. High population density, increased mobility, a larger elderly population, extensive public transportation use, climate variations, and healthcare resource availability all contribute to the varied impact seen across different counties. Understanding these factors is crucial for formulating targeted public health responses and preparing for future pandemics. By leveraging this data, policymakers can identify at-risk areas and allocate resources more effectively, ensuring that the most vulnerable populations receive the protection and care they need. This holistic approach is essential for mitigating the impact of COVID-19 and improving the resilience of communities against future public health threats.


