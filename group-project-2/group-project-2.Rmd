---
title: "Group exercise 2: Analysing spatial data"
subtitle: "DATA5207: Data Analysis in the Social Sciences"
author: Emily and Sarah
output:
  pdf_document:
    toc: no
    latex_engine: xelatex
header-includes:
   - \usepackage{caption}
   - \captionsetup[figure]{font=scriptsize}
mainfont: Avenir Book
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(janitor)
library(sf)
# install.packages("fuzzyjoin")
library(fuzzyjoin) # to join on inexact matches 
library(scales) # adds percentage marks to legend
library(patchwork) #to combin plots
library(ggplot2)
library(rmapshaper)
```

# Introduction

We will be examining the relationship between opiate drug prescriptions and poverty (your independent variables), and mortality caused by drugs and alcohol using the methods covered in this lab, and previously in this unit. The spatial aspect of this is that we are going to use county-level data sourced from the \*US Census Bureau\* and the \*Centers for Disease Control and Prevention (CDC)\*.

We have included two additional variables from county.data:

- State of each county: Because different states in the US have different laws which may affect access to drugs and alcohol

- Education - Percent of adults with a high school diploma only 2014-18: We believe this is a confounding factor of poverty and mortality from drugs since education will affect the jobs you are able to obtain (leading to poverty if unobtainable) and educated drug usage (which we are assuming gets taught in high school in the US). If they haven't been to high school, there is a more likely abuse of drugs since they are uneducated on the effects on their drug usage. Similarly, with poverty, if they are uneducated, they are less likely to have the skills to get a job and be able to obtain an income and then are more likely to enter poverty. 


## Data cleaning

Firstly, we shall load all the data files.

```{r load other census data, warning=FALSE}
load(
  "US data for group task/Other census data/county.data.RData")

```


```{r load poverty data, warning=FALSE}

poverty.data <- read.csv(
  "US data for group task/poverty/poverty data - ACS_16_5YR_S1702_with_ann.csv", 
  skip = 1, header = T)

```


```{r load mortality data, warning=FALSE}

drugs.mort.data <- read.table(
  "US data for group task/mortality/Drugs and alcohol Cause of Death, 1999-2016.txt", 
    sep = '\t', header = T)

```


```{r load data on opioid prescription rates}

opioids.data <- read.csv("US data for group task/opioids/opioids prescribing rates.csv")

```

```{r link us data with shape files, message=FALSE, warning=FALSE}

us.shape.1 <- 
  st_read("US data for group task/US shapefiles/cb_2016_us_county_20m.shp")


```

```{r load fip concordance file}

fip.concordance <- read.csv("US data for group task/fips concordance.csv")

```


\vspace{6mm}

We will join datasets on their similar column - the FIPs code for the county:


```{r compare structure of ID vars, warning=FALSE}

head(poverty.data$Id2)

head(drugs.mort.data$County.Code)

head(county.data$FIPS)

head(opioids.data$FIPS.County.Code)

```


\vspace{6mm}

```{r merge poverty and death data, warning=FALSE, message=FALSE}


patterns <- c(' County| Parish| city| Borough| Census Area')

main.data <- merge(
  poverty.data %>% 
    dplyr::rename(below.poverty.rate = 
             All.families....Percent.below.poverty.level..Estimate..Families)  %>% 
    dplyr::select(Id2, below.poverty.rate),
  drugs.mort.data %>% 
    dplyr::rename(Id2 = County.Code,
                mortality.rate = Crude.Rate) %>% 
    mutate(county = gsub(patterns, "", County))  %>%
    dplyr::select(Id2, county, mortality.rate))

```


```{r}
main.data <- merge(
  main.data %>%
    dplyr::select(Id2, county, mortality.rate, below.poverty.rate),
  county.data %>%
    dplyr::rename(Id2 = FIPS,
                 county.state = State,
                 education.highschool = Percent.of.adults.with.less.than.a.high.school.diploma.2014.18) %>%
    mutate(z.highschool = (education.highschool - mean(education.highschool, na.rm=T)) /
           sd(education.highschool, na.rm=T)) %>%
    dplyr::select(Id2, county.state, education.highschool, z.highschool)
)

```

```{r merge opioids data with county data}


main.data <- merge(
  main.data  %>%
  mutate(z.poverty = (below.poverty.rate - mean(below.poverty.rate, na.rm=T)) / 
           sd(below.poverty.rate, na.rm=T)), 
  opioids.data %>%
  dplyr::rename(Id2 = FIPS.County.Code) %>% 
  mutate(z.opiates = (X2016.Prescribing.Rate - mean(X2016.Prescribing.Rate, na.rm=T)) /
           sd(X2016.Prescribing.Rate, na.rm=T)) %>%
    dplyr::select(Id2, z.opiates, X2016.Prescribing.Rate))

```



Viewing the first six rows of our new data frame, we can see the structure of these data:
\vspace{6mm}

```{r view structure of new dataset, echo=FALSE,  warning=FALSE, message=FALSE}

head(main.data)

```
The first row is the ID variable we used to merge our data frames. The below.poverty.rate is the percentage of each county's families with incomes below the poverty rate. county, the name of each country (and the state within which they sit) while as county.state is the state code. X2016.Prescribing.Rate is the rate of opiod prescriptions. education.highschool is the percentage that completed highschool only. Finally, the mortality rate associated with drug and alcohol use (per 100,000 people). 


In this code, we also standardise the education, poverty and prescription rates in the same line of block of code that we use to merge the data.


There is one last edit to make to these data before we examine them. If you run the code

```{r}
levels(as.factor(main.data$mortality.rate))
```

you will see that some of the observations for the variable `mortality.rate` are coded as 'Unreliable'. This creates two issues for us. Those observations are effectively missing for our purposes, and this converts the variable to a string when we want it to be a number.


\vspace{6mm}

```{r editing mortality rate, warning=FALSE, message=FALSE}

main.data <- main.data %>% 
  mutate(mortality.rate = ifelse(mortality.rate == 'Unreliable', 
                                 NA, as.numeric(as.character(mortality.rate))))

           
```


We then want to link these shapefiles to the county results.
This file, which we were required to modify a little above, can be matched to the shapefile data using similar syntax to above:  

\vspace{6mm}

```{r link shapefiles with fip concordance file}


us.shape.2 <- us.shape.1 %>% 
  merge(fip.concordance %>%
          mutate(STATEFP =  ifelse(Numeric.code >= 0 & Numeric.code <= 9, 
                             paste0(0 , Numeric.code), Numeric.code)) %>%
          dplyr::rename(state = Alpha.code))

        
```

We edit the variable containing county names in shapefile using the `paste0()` function, which combines the county name with the state abbreviation (from the fip concordance file). We then modify county names with some different spelling in the shapefiles and our county level data:

\vspace{6mm}

```{r edit county name in shapefile}

us.shape.2$county <- paste0(us.shape.2$NAME, ", ", us.shape.2$state)

us.shape.2$county <- gsub("DoÃ±a Ana, NM", "Dona Ana, NM", us.shape.2$county)
us.shape.2$county <- gsub("LaSalle, LA", "La Salle, LA", us.shape.2$county)
us.shape.2$county <- gsub("Oglala Lakota, SD", "Oglala, SD", us.shape.2$county)

```

\vspace{6mm}


And then we merge the shapefile and the county-level data:


\vspace{6mm}


```{r link us data with shape files2}

us.shape.2 <- full_join(us.shape.2,
  main.data %>%
    dplyr::select(county, below.poverty.rate, mortality.rate, X2016.Prescribing.Rate)) %>%
  st_as_sf() # To acknolwedge its a shape file


```
```{r}
us.shape.2
```

\vspace{6mm}


You are now ready to map these data. Good luck with the rest of the exercise! 

```{r}
main.data = drop_na(main.data, mortality.rate, z.poverty, z.opiates, z.highschool)

cannabis_legality <- data.frame(
  county.state = c("AL", "AK", "AZ", "AR", "CA", 
            "CO", "CT", "DE", "FL", "GA", 
            "HI", "ID", "IL", "IN", "IA", 
            "KS", "KY", "LA", "ME", "MD", 
            "MA", "MI", "MN", "MS", 
            "MO", "MT", "NE", "NV", "NH", 
            "NJ", "NM", "NY", "NC", 
            "ND", "OH", "OK", "OR", "PA", 
            "RI", "SC", "SD", "TN", 
            "TX", "UT", "VT", "VA", "WA", 
            "WV", "WI", "WY", "DC"),
  Legality_Status = c("Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical Only", 
                      "Legal for Medical and Recreational", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical Only", 
                      "Legal for Medical Only", "Illegal", "Legal for Medical and Recreational", 
                      "Legal for Medical Only", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Decriminalized", 
                      "Legal for Medical and Recreational", "Legal for Medical Only", 
                      "Legal for Medical and Recreational", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical Only", "Legal for Medical Only", 
                      "Legal for Medical Only", "Legal for Medical and Recreational", 
                      "Legal for Medical and Recreational", "Legal for Medical and Recreational", 
                      "Legal for Medical Only", "Legal for Medical Only", "Illegal", 
                      "Legal for Medical and Recreational")
)

legalplus.main.data = merge(main.data, cannabis_legality, by = "county.state", all = TRUE)
```



## Descriptive Analysis

1\. Conduct some descriptive analyses of these data. You can examine this using scatter plots and correlation coefficients. Do you need to transform any of the variables

```{r}
library(ggplot2)


ggplot(main.data, aes(x = mortality.rate)) +
  geom_histogram(bins = 30, fill = "blue", color = "black") +
  ggtitle("Distribution of Mortality Rates") +
  xlab("Mortality Rate") +
  ylab("Frequency")


ggplot(legalplus.main.data, aes(x = Legality_Status, y = mortality.rate, fill = Legality_Status)) +
  geom_boxplot() +
  ggtitle("Mortality Rate by Cannabis Legality Status") +
  xlab("Cannabis Legality Status") +
  ylab("Mortality Rate")


ggplot(main.data, aes(x = z.poverty, y = mortality.rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  ggtitle("Mortality Rate vs. Poverty Rate") +
  xlab("Below Poverty Rate") +
  ylab("Mortality Rate")

ggplot(main.data, aes(x = z.highschool, y = mortality.rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  ggtitle("High School Rates vs. Mortality Rate") +
  xlab("High School Rates") +
  ylab("Mortality Rate")

ggplot(main.data, aes(x = z.opiates, y = mortality.rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, color = "green") +
  ggtitle("Mortality Rate vs. Opiate use") +
  xlab("Opiate use") +
  ylab("Mortality Rate")


ggplot(legalplus.main.data, aes(x = Legality_Status, fill = Legality_Status)) +
  geom_bar() +
  ggtitle("Number of Counties by Cannabis Legality Status") +
  xlab("Cannabis Legality Status") +
  ylab("Count")

ggplot(legalplus.main.data, aes(x = X2016.Prescribing.Rate, y = mortality.rate)) +
  geom_point(aes(color = Legality_Status), alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~Legality_Status) +
  ggtitle("Perscription Rates vs. Mortality Rate by Cannabis Legality Status") +
  xlab("Perscription Rate") +
  ylab("Mortality Rate")
```




## Relationship of dependent and independent variables

How does poverty and opiate prescriptions predict mortality rates associated with drugs and alcohol? Some other data is provided in the data folder, and you should take a few variables or controls from this.

2\. Fit regressions to your data. What is the appropriate type of regression and why have you chosen it?

Since our dependent variable mortality.rate is a numerical value, it is appropriate the model this using a linear regression model.

Make sure to drop the NA values for all the other columns:

```{r}
legalplus.main.data = drop_na(legalplus.main.data, mortality.rate, z.poverty, z.opiates, z.highschool, Legality_Status)
```

Ensure that the county states are coded for each State

```{r}
tabyl(main.data, county.state)
```

```{r}
# levels(as.factor(main.data$county.state))

main.data$county.state <- relevel(as.factor(main.data$county.state), ref = "TX")

```


Model includes the standardised numerical variables and state.

```{r}
regmodel <- lm(mortality.rate ~ z.poverty + z.opiates + z.highschool  + Legality_Status, data = legalplus.main.data)

summary(regmodel)
```




### Interpretations
For this model, the baseline is State AK or Alaska, thus the intercept represents the mortality rate holding all other predictors at 0.

### Model Fit

## Map

3\. Create at least one map that helps explain your findings (we will show you how to do this in the next session).

```{r}
# Create the ggplot object
plot <- ggplot(us.shape.2) +
  geom_sf(mapping = aes(fill = mortality.rate), colour = NA, inherit.aes = FALSE) +
  coord_sf(xlim = c(-180, -65), ylim = c(24, 72), expand = FALSE) +
  scale_fill_gradient2(low = "dark blue",
                       high = "dark green",
                       midpoint = mean(us.shape.2$mortality.rate, na.rm = TRUE),
                       limits = c(min(us.shape.2$mortality.rate, na.rm = TRUE),
                                  max(us.shape.2$mortality.rate, na.rm = TRUE)),
                       label = scales::comma,
                       na.value = "grey") +
  labs(title = 'Mortality Rate distribution') +
  guides(fill = guide_legend(keyheight = 0.3)) +
  theme_void() +
  theme(plot.title = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank())

options(repr.plot.width = 12, repr.plot.height = 10)  # Adjust width and height as needed
plot  # Display the plot
```

```{r}
# Create the ggplot object
plot <- ggplot(us.shape.2) +
  geom_sf(mapping = aes(fill = below.poverty.rate), colour = NA, inherit.aes = FALSE) +
  coord_sf(xlim = c(-180, -65), ylim = c(24, 72), expand = FALSE) +
  scale_fill_gradient2(low = "dark blue",
                       high = "dark green",
                       midpoint = mean(us.shape.2$below.poverty.rate, na.rm = TRUE),
                       limits = c(min(us.shape.2$below.poverty.rate, na.rm = TRUE),
                                  max(us.shape.2$below.poverty.rate, na.rm = TRUE)),
                       label = scales::comma,
                       na.value = "grey") +
  labs(title = 'Mortality Rate distribution') +
  guides(fill = guide_legend(keyheight = 0.3)) +
  theme_void() +
  theme(plot.title = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank())

options(repr.plot.width = 12, repr.plot.height = 10)  # Adjust width and height as needed
plot  # Display the plot
```
```{r}
# Create the ggplot object
plot <- ggplot(us.shape.2) +
  geom_sf(mapping = aes(fill = X2016.Prescribing.Rate), colour = NA, inherit.aes = FALSE) +
  coord_sf(xlim = c(-180, -65), ylim = c(24, 72), expand = FALSE) +
  scale_fill_gradient2(low = "dark blue",
                       high = "dark green",
                       midpoint = mean(us.shape.2$X2016.Prescribing.Rate, na.rm = TRUE),
                       limits = c(min(us.shape.2$X2016.Prescribing.Rate, na.rm = TRUE),
                                  max(us.shape.2$X2016.Prescribing.Rate, na.rm = TRUE)),
                       label = scales::comma,
                       na.value = "grey") +
  labs(title = 'Mortality Rate distribution') +
  guides(fill = guide_legend(keyheight = 0.3)) +
  theme_void() +
  theme(plot.title = element_text(size = 12),
        legend.position = 'bottom',
        legend.title = element_blank())

options(repr.plot.width = 12, repr.plot.height = 10)  # Adjust width and height as needed
plot  # Display the plot
```

## Discussion

4\. Write up your key results.

You will be marked on the quality of your \$R\$ code (including whether it runs for us without errors), how well you have justified your variable selection, the proper use of appropriate methods.
