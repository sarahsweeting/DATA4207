---
title: "Group exercise 2: Analysing spatial data"
subtitle: "DATA5207: Data Analysis in the Social Sciences"
author: Emily and Sarah
output:
  pdf_document:
    toc: no
    latex_engine: xelatex
header-includes:
   - \usepackage{caption}
   - \captionsetup[figure]{font=scriptsize}
mainfont: Avenir Book
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
```

# Introduction

We will be examining the relationship between opiate drug prescriptions and poverty (your independent variables), and mortality caused by drugs and alcohol using the methods covered in this lab, and previously in this unit. The spatial aspect of this is that we are going to use county-level data sourced from the \*US Census Bureau\* and the \*Centers for Disease Control and Prevention (CDC)\*.

We have included two additional variables to 

State of each county

Education - Percent of adults with a high school diploma only 2014-18


## Data cleaning

```{r load other census data, warning=FALSE}
load(
  "US data for group task/Other census data/county.data.RData")

```


```{r load poverty data, warning=FALSE}

poverty.data <- read.csv(
  "US data for group task/poverty/poverty data - ACS_16_5YR_S1702_with_ann.csv", 
  skip = 1, header = T)

```


```{r load mortality data, warning=FALSE}

drugs.mort.data <- read.table(
  "US data for group task/mortality/Drugs and alcohol Cause of Death, 1999-2016.txt", 
    sep = '\t', header = T)

```


```{r load data on opioid prescription rates}

opioids.data <- read.csv("US data for group task/opioids/opioids prescribing rates.csv")

```

```{r link us data with shape files, message=FALSE, warning=FALSE}

us.shape.1 <- 
  st_read("US data for group task/US shapefiles/cb_2016_us_county_20m.shp")


```

```{r load fip concordance file}

fip.concordance <- read.csv("US data for group task/fips concordance.csv")

```


\vspace{6mm}

```{r compare names of ID vars, warning=FALSE}

names(poverty.data)[3]

names(drugs.mort.data)[2]


```
When two datasets have a variable named and structured identically, it is simple to combine them. However, in this instance, the names of our ID variables don't match, even though their structure does:

\vspace{6mm}

```{r compare structure of ID vars, warning=FALSE}

head(poverty.data$Id2)

head(drugs.mort.data$County.Code)

```


```{r}
county.data$Sta
```

\vspace{6mm}

```{r merge poverty and death data, warning=FALSE, message=FALSE}


patterns <- c(' County| Parish| city| Borough| Census Area')

main.data <- merge(
  poverty.data %>% 
    dplyr::rename(below.poverty.rate = 
             All.families....Percent.below.poverty.level..Estimate..Families)  %>% 
    dplyr::select(Id2, below.poverty.rate),
  drugs.mort.data %>% 
    dplyr::rename(Id2 = County.Code,
                mortality.rate = Crude.Rate) %>% 
    mutate(county = gsub(patterns, "", County))  %>%
    dplyr::select(Id2, county, mortality.rate))

```

```{r}
main.data <- merge(
  main.data %>%
    dplyr::select(Id2, county, mortality.rate, below.poverty.rate),
  county.data %>%
    dplyr::rename(Id2 = FIPS,
                 county.state = State,
                 education.highschool = Percent.of.adults.with.a.high.school.diploma.only.2014.18) %>%
    dplyr::select(Id2, county.state, education.highschool)
)
```

We now have a new dataset with `r dim(county.data)[2]` variables and `r dim(county.data)[1]` rows. Viewing the first six rows of our new data frame, we can see the structure of these data:
\vspace{6mm}

```{r view structure of new dataset, echo=FALSE,  warning=FALSE, message=FALSE}

head(main.data)

```
The first row is the ID variable we used to merge our data frames. The second, the percentage of each county's families with incomes below the poverty rate. Third, the names of each country (and the state within which they sit). Finally, the mortality rate associated with drug and alcohol use (per 100,000 people).

There is one last edit to make to these data before we examine them. If you run the code

```{r}
levels(as.factor(main.data$mortality.rate))
```

you will see that some of the observations for the variable `mortality.rate` are coded as 'Unreliable'. This creates two issues for us. Those observations are effectively missing for our purposes, and this converts the variable to a string when we want it to be a number.


\vspace{6mm}

```{r editing mortality rate, warning=FALSE, message=FALSE}

main.data <- main.data %>% 
  mutate(mortality.rate = ifelse(mortality.rate == 'Unreliable', 
                                 NA, as.numeric(as.character(mortality.rate))))

           
```

We then use the same steps as above to merge this data with our `county.data` frame:

\vspace{6mm}

```{r merge opioids data with county data}


main.data <- merge(
  main.data  %>%
  mutate(z.poverty = (below.poverty.rate - mean(below.poverty.rate, na.rm=T)) / 
           sd(below.poverty.rate, na.rm=T)), 
  opioids.data %>%
  dplyr::rename(Id2 = FIPS.County.Code) %>% 
  mutate(z.opiates = (X2016.Prescribing.Rate - mean(X2016.Prescribing.Rate, na.rm=T)) /
           sd(X2016.Prescribing.Rate, na.rm=T)) %>%
    dplyr::select(Id2, z.opiates, X2016.Prescribing.Rate))

```

In this code, we also standardise the poverty prescription rates in the same line of block of code that we use to merge the data.

We then want to link these shapefiles to the county results.
This file, which we were required to modify a little above, can be matched to the shapefile data using similar syntax to above:  

\vspace{6mm}

```{r link shapefiles with fip concordance file}


us.shape.2 <- us.shape.1 %>% 
  merge(fip.concordance %>%
          mutate(STATEFP =  ifelse(Numeric.code >= 0 & Numeric.code <= 9, 
                             paste0(0 , Numeric.code), Numeric.code)) %>%
          dplyr::rename(state = Alpha.code))

        
```

We edit the variable containing county names in shapefile using the `paste0()` function, which combines the county name with the state abbreviation (from the fip concordance file). We then modify county names with some different spelling in the shapefiles and our county level data:

\vspace{6mm}

```{r edit county name in shapefile}

us.shape.2$county <- paste0(us.shape.2$NAME, ", ", us.shape.2$state)

us.shape.2$county <- gsub("DoÃ±a Ana, NM", "Dona Ana, NM", us.shape.2$county)
us.shape.2$county <- gsub("LaSalle, LA", "La Salle, LA", us.shape.2$county)
us.shape.2$county <- gsub("Oglala Lakota, SD", "Oglala, SD", us.shape.2$county)

```

\vspace{6mm}


And then we merge the shapefile and the county-level data:


\vspace{6mm}


```{r link us data with shape files2}

us.shape.2 <- full_join(us.shape.2,
  main.data %>%
    dplyr::select(county, below.poverty.rate, mortality.rate, X2016.Prescribing.Rate))


```

\vspace{6mm}

TODO:
- clean out unreliable mortality data??


You are now ready to map these data. Good luck with the rest of the exercise! 

## Descriptive Analysis

1\. Conduct some descriptive analyses of these data. You can examine this using scatter plots and correlation coefficients. Do you need to transform any of the variables




## Relationship of dependent and independent variables

How does poverty and opiate prescriptions predict mortality rates associated with drugs and alcohol? Some other data is provided in the data folder, and you should take a few variables or controls from this.

2\. Fit regressions to your data. What is the appropriate type of regression and why have you chosen it?
```{r}


```


```{r}
main.data = drop_na(main.data, mortality.rate)
```

```{r}
regmodel <- lm(mortality.rate ~ z.poverty + z.opiates, data = county.data)

# Summarise the regression model
summary(regmodel)
```


## Map

3\. Create at least one map that helps explain your findings (we will show you how to do this in the next session).

## Discussion

4\. Write up your key results.

You will be marked on the quality of your \$R\$ code (including whether it runs for us without errors), how well you have justified your variable selection, the proper use of appropriate methods.
